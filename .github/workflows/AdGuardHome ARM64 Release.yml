name: AdGuardHome ARM64 å‹ç¼©å‘å¸ƒ

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC æ—¶é—´ 00:00 è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  process-release:
    runs-on: ubuntu-latest
    steps:
    - name: å®‰è£…ä¾èµ–å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y wget upx

    - name: è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
      id: version_info
      run: |
        # è·å–æœ€æ–°ç‰ˆæœ¬å·
        LATEST_TAG=$(curl -sL "https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest" | grep '"tag_name":' | cut -d'"' -f4)
        # è·å–åŸå§‹æ–‡ä»¶å
        ORIGINAL_NAME="AdGuardHome_linux_arm64.tar.gz"
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "filename=$ORIGINAL_NAME" >> $GITHUB_OUTPUT
        echo "release_name=AdGuardHome ARM64 UPXç‰ˆ ($LATEST_TAG)" >> $GITHUB_OUTPUT

    - name: ä¸‹è½½å®˜æ–¹å®‰è£…åŒ…
      run: |
        wget "https://github.com/AdguardTeam/AdGuardHome/releases/download/${{ steps.version_info.outputs.version }}/${{ steps.version_info.outputs.filename }}"

    - name: è§£å‹å¹¶å‹ç¼©äºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        # è§£å‹åŸå§‹åŒ…
        tar -xzf "${{ steps.version_info.outputs.filename }}"
        
        # ä½¿ç”¨ UPX å‹ç¼©å¯æ‰§è¡Œæ–‡ä»¶ (LZMA æœ€ä½³å‹ç¼©)
        upx --best --lzma AdGuardHome/AdGuardHome -o AdGuardHome/AdGuardHome.upx
        
        # æ›¿æ¢åŸå§‹æ–‡ä»¶
        mv AdGuardHome/AdGuardHome.upx AdGuardHome/AdGuardHome
        
        # é‡æ–°æ‰“åŒ…ä¸ºåŒå gzip
        tar -czf "${{ steps.version_info.outputs.filename }}" AdGuardHome

    - name: å‘å¸ƒåˆ° GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.version_info.outputs.filename }}
        tag_name: "arm64-upx-${{ steps.version_info.outputs.version }}"
        name: ${{ steps.version_info.outputs.release_name }}
        body: |
          ğŸ”§ è‡ªåŠ¨ç”Ÿæˆçš„ UPX å‹ç¼©ç‰ˆ AdGuardHome
          - æºç‰ˆæœ¬: ${{ steps.version_info.outputs.version }}
          - æ¶æ„: ARM64
          - å‹ç¼©æ–¹å¼: UPX --best --lzma
          - ç”Ÿæˆæ—¶é—´: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      run: |
        rm -rf AdGuardHome*
